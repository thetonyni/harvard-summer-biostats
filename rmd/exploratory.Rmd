---
title: "Exploratory Analysis"
author: "Tony Ni, Antonella Basso, Jose Lopez"
date: "6/11/2020"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Libraries
```{r, include = FALSE}
library(mdsr)
library(tidyverse)
library(ggplot2)
```

Goals:

comparing how upgradients look vs downgradients through a graph (make sure the average thing/wrangling to fix it)

pick a chemical of interest

histograms of concentrations (one for upgradient vs downgradient for a single site)

compare the compare the 2 powerplants overall (upgradient at one vs the other)

regression

## Reading in Data

```{r}
setwd("~/harvard-summer-biostats")
illinois <- read_csv("data/illinois.csv") #read in data
```

## Checking unique/distinct levels

```{r}
#check how many observations there
nrow(illinois)

#checking distincts sites
unique(illinois$site)

#checking distinct gradient
unique(illinois$gradient)

#checking distinct gradient
unique(illinois$measurement.unit)

#checking disposal area
unique(illinois$disposal.area)

#checking type (L = land fuel, SI = surface impoundement, M = mixed/multiunit)
#there will be multiple different dumpsites at a powerplant site. some sites are wet (ponds of water where they throw ash of water), some sits are dry landfill (heaps of coal ash), the type is just a 
unique(illinois$type)

illinois %>%
  group_by(type) %>%
  summarize(n())

illinois %>%
  group_by(measurement.unit) %>%
  summarize(n())

#checking wells
illinois %>%
  group_by(well.id) %>%
  summarize(n())
```

use illinois and newyork

lower detection limit (if a chemical is really low, it can't differentiate beyond a certain low level, it might be the values with all teh same values)

all of the contaminants are harmful, some chemicals are more useful for detecting coal contamination (most important/indicative of coal contamination is boron (occurs at really high levels in coal)),

looking at the report given to us might be good about the different chemicals in coal (if we are curious)

total dissolved solids are probably not important, imprevise measurement of how much "crap is in the water" - doesnt represent any toxic chemicals

## Wrangling

```{r, warning = FALSE}
illinois1 <- illinois %>%
  select(site, disposal.area, type, well.id, gradient, contaminant, 
         measurement.unit, concentration) %>%
  mutate(well.id_contaminant = paste0(well.id, "_", contaminant)) %>% #for future use
  rename(c("disposal_area" = "disposal.area", "well_id" = "well.id",
           "unit" = "measurement.unit"))

#fixing 'contaminant' string by removing everything after the comma
illinois1$contaminant=gsub(", total", "", illinois1$contaminant)

#testing
avg_contaminant <- illinois1 %>%
  group_by(well_id, contaminant) %>% 
  summarise_each(funs(mean)) %>%
  select(1,2,8) #selecting only numeric columns

#temporarily uniting columns for joining in next step
temp <- avg_contaminant %>%
  unite("well.id_contaminant", well_id, contaminant)

#joining orig dataframe and avg_contaminant dataframe
combined <- left_join(temp, illinois1, by = "well.id_contaminant") %>%
  distinct(well.id_contaminant, .keep_all = TRUE) %>%
  separate(well.id_contaminant, c('well_id', 'contaminant'), sep="_") %>%
  select(1:8)

#spreading to wide data frame format to add missing info
combined2 <- combined %>% #collapse empty rows
  spread(contaminant, concentration.x) %>%
  group_by(well_id) %>%
  summarise_each(funs(first(.[!is.na(.)]))) %>%
  select(-c(unit))

#gathering back to long data frame format
combined3 <- combined2 %>%
  gather("contaminant", "concentration", 6:26)
```

## Summary Statistics

```{r}
illinois %>%
  group_by(contaminant) %>%
  summarize(mean_concentration = mean(concentration))
```

## Visualizations

```{r}
#looking at one specific well and the contaminant concentrations within it

ggplot(data = combined3 %>%
         filter(well_id == "03R"), aes(x = contaminant, y = concentration,
                                       fill = contaminant)) + 
  geom_bar(stat = "identity", show.legend = FALSE) + 
  xlab("Contaminant") +
  ylab("Concentration") +
  ggtitle("Concentration of Contaminants in Well 03R") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

#looking at one contaminant for all wells (counts)

ggplot(data = combined3 %>%
         filter(contaminant == "Antimony"), 
       aes(x = well_id, y = concentration, fill = well_id)) +
  geom_bar(stat = "identity", show.legend = FALSE) +
  xlab("Well ID") +
  ylab("Concentration") +
  ggtitle("Concentration of Antimony across Wells") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

levels(as.factor(illinois1$well.id))
```

The histogram is incompehensible, there are way too many wells in Illinois. 
Unsure, but having to make all these plots constantly seems unreasonable for all of these potential wells and contaminants to look through, maybe we could make some sort of Shiny app to help with this?
