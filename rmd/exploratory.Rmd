---
title: "Exploratory Analysis"
author: "Tony Ni, Antonella Basso, Jose Lopez"
date: "6/11/2020"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Libraries
```{r, include = FALSE}
library(mdsr)
library(tidyverse)
library(ggplot2)
```

Goals:

comparing how upgradients look vs downgradients through a graph (make sure the average thing/wrangling to fix it)

pick a chemical of interest

histograms of concentrations (one for upgradient vs downgradient for a single site)

compare the compare the 2 powerplants overall (upgradient at one vs the other)

regression

## Reading in Data

```{r}
setwd("~/harvard-summer-biostats")
illinois <- read_csv("data/illinois.csv") #read in data
```

## Checking unique/distinct levels

```{r}
#check how many observations there
nrow(illinois)

#checking distincts sites
unique(illinois$site)

#checking distinct gradient
unique(illinois$gradient)

#checking distinct gradient
unique(illinois$measurement.unit)

#checking disposal area
unique(illinois$disposal.area)

#checking type (L = land fuel, SI = surface impoundement, M = mixed/multiunit)
#there will be multiple different dumpsites at a powerplant site. some sites are wet (ponds of water where they throw ash of water), some sits are dry landfill (heaps of coal ash), the type is just a 
unique(illinois$type)

illinois %>%
  group_by(type) %>%
  summarize(n())

illinois %>%
  group_by(measurement.unit) %>%
  summarize(n())

#checking wells
illinois %>%
  group_by(well.id) %>%
  summarize(n())
```

use illinois and newyork

lower detection limit (if a chemical is really low, it can't differentiate beyond a certain low level, it might be the values with all teh same values)

all of the contaminants are harmful, some chemicals are more useful for detecting coal contamination (most important/indicative of coal contamination is boron (occurs at really high levels in coal)),

looking at the report given to us might be good about the different chemicals in coal (if we are curious)

total dissolved solids are probably not important, imprevise measurement of how much "crap is in the water" - doesnt represent any toxic chemicals

## Wrangling

```{r, warning = FALSE}
illinois1 <- illinois %>%
  select(site, disposal.area, type, well.id, gradient, contaminant, 
         measurement.unit, concentration) %>%
  mutate(well.id_contaminant = paste0(well.id, "_", contaminant)) %>% #for future use
  rename(c("disposal_area" = "disposal.area", "well_id" = "well.id",
           "unit" = "measurement.unit"))

#fixing 'contaminant' string by removing everything after the comma
illinois1$contaminant=gsub(", total", "", illinois1$contaminant)

#testing
avg_contaminant <- illinois1 %>%
  group_by(well_id, contaminant) %>% 
  summarise_each(funs(mean)) %>%
  select(1,2,8) #selecting only numeric columns

#temporarily uniting columns for joining in next step
temp <- avg_contaminant %>%
  unite("well.id_contaminant", well_id, contaminant)

#joining orig dataframe and avg_contaminant dataframe
combined <- left_join(temp, illinois1, by = "well.id_contaminant") %>%
  distinct(well.id_contaminant, .keep_all = TRUE) %>%
  separate(well.id_contaminant, c('well_id', 'contaminant'), sep="_") %>%
  select(1:8)

#spreading to wide data frame format to add missing info
combined2 <- combined %>% #collapse empty rows
  spread(contaminant, concentration.x) %>%
  group_by(well_id) %>%
  summarise_each(funs(first(.[!is.na(.)]))) %>%
  select(-c(unit))

#gathering back to long data frame format
combined3 <- combined2 %>%
  gather("contaminant", "concentration", 6:26)
```

## Summary Statistics

```{r}
illinois %>%
  group_by(contaminant) %>%
  summarize(mean_concentration = mean(concentration))
```

## Visualizations

```{r}
#looking at one specific well and the contaminant concentrations within it

ggplot(data = combined3 %>%
         filter(well_id == "03R"), aes(x = contaminant, y = concentration,
                                       fill = contaminant)) + 
  geom_bar(stat = "identity", show.legend = FALSE) + 
  xlab("Contaminant") +
  ylab("Concentration") +
  ggtitle("Concentration of Contaminants in Well 03R") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

#looking at one contaminant for all wells (counts)

ggplot(data = combined3 %>%
         filter(contaminant == "Antimony"), 
       aes(x = well_id, y = concentration, fill = well_id)) +
  geom_bar(stat = "identity", show.legend = FALSE) +
  xlab("Well ID") +
  ylab("Concentration") +
  ggtitle("Concentration of Antimony across Wells") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```

The histogram is incompehensible, there are way too many wells in Illinois. 
Unsure, but having to make all these plots constantly seems unreasonable for all of these potential wells and contaminants to look through, maybe choose only those wells with concentration values greater than some certain value? (0.001 maybe?)

```{r}
ggplot(data = combined3 %>%
         filter(contaminant == "Carbon") %>%
         filter(concentration > 1), 
       aes(x = well_id, y = concentration, fill = well_id)) +
  geom_bar(stat = "identity", show.legend = FALSE) +
  xlab("Well ID") +
  ylab("Concentration") +
  ggtitle("Concentration of Antimony across Wells") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

levels(as.factor(combined3$contaminant))
```

First Goal: Identify contaminated upgradient wells
How?: Ask Luli?

we could see that in an exploratory analysis, look at histogram of different chemcials at each well -- there should be variation btwn upgradients at the same sites and general amt of different between upgradient at one site vs another site... one source of variation is the site and wells will also have some variation in their measurement too... make histograms for all chemcials and visualize them side by side and see if theres anydiffernces between upgradients and downgradients, and check if any differences between upgradients.. statistically there is a way... group them by upgradient vs downgradient (groupby chemicals and plot x variable concentration, and facet by the gradient (either up or down) and get histograms for each)

In the powerpoint, it talks about comparing upgradient wells within 100 mi radius of each other, how should we go about getting this distance data since it isn't provided? Should we try to use outside data/geospatial data to do this?

Which contaminants are carcinogenic?

What are detection monitory constituents vs. assessment monitoring constituents?

Plot 1: Compare concentrations at a small number of upgradient wells with other upgradient wells at the same site.

Plot 2: Compare measurem

Looking at https://www.uky.edu/KGS/coal/coal-major-minor-trace-elements.php , we find that the major elements in coal consist of: Hydrogen, Carbon, Nitrogen, Oxygen, and Sulfur with the minor elements in coal being: Sodium, Aluminum, Silicon, Phosphorous, Potassium, Calcium, Titanium, Manganese, and Iron

The contaminants being measured in our case are Sulfate (a compound containing sulfur), Calcium, 




